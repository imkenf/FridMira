From a5c25cecea01a3224d7512e5a79a0f67df40ff6c Mon Sep 17 00:00:00 2001
From: imkenf <imkenf@gmail.com>
Date: Fri, 20 Jun 2025 17:03:55 +0800
Subject: [PATCH 005/006] FridMira post-preload initialization

---
 src/control-service.vala | 178 +++++++++++++++++++++++++++++++++++++--
 1 file changed, 170 insertions(+), 8 deletions(-)

diff --git a/src/control-service.vala b/src/control-service.vala
index cc64470f..cf10fbed 100644
--- a/src/control-service.vala
+++ b/src/control-service.vala
@@ -1,5 +1,13 @@
 namespace Frida {
-	public sealed class ControlService : Object {
+	[DBus (name = "re.frida.Control")]
+	private interface Control : GLib.Object {
+		// ... existing code ...
+	}
+
+	[CCode (cname = "_frida_internal_init_fridmira")]
+	internal extern void initialize_fridmira_framework () throws IOError;
+
+	public class ControlService : Object {
 		public EndpointParameters endpoint_params {
 			get;
 			construct;
@@ -110,6 +118,10 @@ namespace Frida {
 			host_session.uninjected.connect (notify_uninjected);
 
 			this.provider = provider;
+
+			main_context = MainContext.ref_thread_default ();
+
+			service.incoming.connect (on_server_connection);
 		}
 
 		public async void start (Cancellable? cancellable = null) throws Error, IOError {
@@ -117,17 +129,124 @@ namespace Frida {
 				throw new Error.INVALID_OPERATION ("Invalid operation");
 			state = STARTING;
 
-			main_context = MainContext.ref_thread_default ();
-
-			service.incoming.connect (on_server_connection);
-
 			try {
 				yield service.start (cancellable);
 
-				if (options.enable_preload) {
+				// CRITICAL: Initialize RPC enhancer BEFORE any preload operations
+				// 关键：在任何preload操作之前初始化RPC增强器
+				bool rpc_enhancer_enabled = false;
+				if (options.fridmira_enabled) {
+					// Check if verbose logging is enabled via environment variable
+					// 通过环境变量检查是否启用详细日志
+					bool verbose_enabled = GLib.Environment.get_variable("FRIDA_VERBOSE") != null;
+
+					if (verbose_enabled) {
+						stdout.printf ("FridMira: Preparing RPC configuration for preload...\n");
+					}
+
+					// Initialize RPC enhancement but don't set enhancer yet for preload compatibility
+					// 初始化RPC增强但暂不设置增强器以确保preload兼容性
+					try {
+						if (FridMiraRpcProtocolEnhancer.is_enhanced_mode_enabled()) {
+							FridMiraRpcProtocolEnhancer.init();
+							rpc_enhancer_enabled = true;
+
+							if (verbose_enabled) {
+								stdout.printf ("FridMira: RPC enhancer initialized (will be activated after preload)\n");
+							}
+						}
+					} catch (Error e) {
+						stderr.printf ("FridMira: WARNING - RPC enhancer setup failed: %s\n", e.message);
+						stderr.printf ("FridMira: Continuing with standard RPC mode\n");
+					}
+				}
+
+				// Perform preload with standard RPC for compatibility with agents
+				// 使用标准RPC执行preload以确保与agents的兼容性
+				if (options.enable_preload && !options.fridmira_no_preload) {
 					var base_host_session = host_session as LocalHostSession;
-					if (base_host_session != null)
-						base_host_session.preload.begin (io_cancellable);
+					if (base_host_session != null) {
+						// Check if verbose logging is enabled
+						bool verbose_enabled = GLib.Environment.get_variable("FRIDA_VERBOSE") != null;
+
+						if (verbose_enabled) {
+							stdout.printf ("FridMira: Starting preload operation with standard RPC (for agent compatibility)...\n");
+						}
+
+						try {
+							// Temporarily ensure standard RPC for preload
+							// 暂时确保preload使用标准RPC
+							var original_enhancer = Frida.RpcClient.enhancer;
+							Frida.RpcClient.enhancer = null;
+
+							yield base_host_session.preload (io_cancellable);
+
+							// Restore enhancer after successful preload
+							// preload成功后恢复增强器
+							Frida.RpcClient.enhancer = original_enhancer;
+
+							if (verbose_enabled) {
+								stdout.printf ("FridMira: Preload complete with standard RPC\n");
+							}
+						} catch (Error e) {
+							if (verbose_enabled) {
+								stderr.printf ("FridMira: Preload failed: %s\n", e.message);
+							}
+							throw e;
+						}
+					}
+				} else {
+					bool verbose_enabled = GLib.Environment.get_variable("FRIDA_VERBOSE") != null;
+					if (verbose_enabled) {
+						if (!options.enable_preload) {
+							stdout.printf ("FridMira: Preload disabled by configuration\n");
+						} else if (options.fridmira_no_preload) {
+							stdout.printf ("FridMira: Preload disabled by --no-preload flag\n");
+						}
+					}
+				}
+
+				// NOW activate RPC enhancer for new connections after preload success
+				// 现在在preload成功后为新连接激活RPC增强器
+				if (rpc_enhancer_enabled && FridMiraRpcProtocolEnhancer.is_enhanced_mode_enabled()) {
+					bool verbose_enabled = GLib.Environment.get_variable("FRIDA_VERBOSE") != null;
+
+					try {
+						// Set the enhancer for future RPC operations
+						// 为未来的RPC操作设置增强器
+						if (Frida.RpcClient.enhancer == null) {
+							Frida.RpcClient.enhancer = new Frida.FridMiraRpcEnhancerAdapter();
+							if (verbose_enabled) {
+								stdout.printf ("FridMira: RPC enhancer activated for new connections\n");
+							}
+						}
+					} catch (Error e) {
+						if (verbose_enabled) {
+							stderr.printf ("FridMira: RPC enhancer activation failed: %s\n", e.message);
+						}
+					}
+				}
+
+				// Framework status report after successful initialization
+				// 成功初始化后的框架状态报告
+				if (options.fridmira_enabled) {
+					bool verbose_enabled = GLib.Environment.get_variable("FRIDA_VERBOSE") != null;
+					if (verbose_enabled) {
+						int active_modules = 0;
+						active_modules += !options.fridmira_no_symbol ? 1 : 0;
+						active_modules += !options.fridmira_no_thread ? 1 : 0;
+						active_modules += !options.fridmira_no_rpc ? 1 : 0;
+						active_modules += !options.fridmira_no_file ? 1 : 0;
+						active_modules += !options.fridmira_no_gum ? 1 : 0;
+						// Agent Management默认禁用，需要FRIDMIRA_AGENT_MODE=1
+						string? agent_mode = GLib.Environment.get_variable("FRIDMIRA_AGENT_MODE");
+						active_modules += (agent_mode == "1") ? 1 : 0;
+
+						stdout.printf ("FridMira: Server ready - %d/6 modules active\n", active_modules);
+						stdout.printf ("FridMira: RPC enhancer: %s\n",
+							(Frida.RpcClient.enhancer != null) ? "ACTIVE" : "INACTIVE");
+						stdout.printf ("FridMira: ======================================\n");
+					}
 				}
 
 				state = STARTED;
@@ -1142,5 +1261,48 @@ namespace Frida {
 			set;
 			default = true;
 		}
+
+		/* FridMira options */
+		public bool fridmira_enabled {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_symbol {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_thread {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_rpc {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_file {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_gum {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_preload {
+			get;
+			set;
+			default = false;
+		}
 	}
 }
-- 
2.45.1.windows.1

