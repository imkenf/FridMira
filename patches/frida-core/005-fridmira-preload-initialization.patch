From 9a129e84468857fd6fcbfe49a86943b6cb25c3e8 Mon Sep 17 00:00:00 2001
From: imkenf <imkenf@gmail.com>
Date: Thu, 19 Jun 2025 09:42:51 +0800
Subject: [PATCH 005/005] Add FridMira framework initialization after preload
 completion

---
 src/control-service.vala | 159 +++++++++++++++++++++++++++++++++++++--
 1 file changed, 153 insertions(+), 6 deletions(-)

diff --git a/src/control-service.vala b/src/control-service.vala
index cc64470..b1c9b27 100644
--- a/src/control-service.vala
+++ b/src/control-service.vala
@@ -1,5 +1,13 @@
 namespace Frida {
-	public sealed class ControlService : Object {
+	[DBus (name = "re.frida.Control")]
+	private interface Control : GLib.Object {
+		// ... existing code ...
+	}
+
+	[CCode (cname = "_frida_internal_init_fridmira")]
+	internal extern void initialize_fridmira_framework () throws IOError;
+
+	public class ControlService : Object {
 		public EndpointParameters endpoint_params {
 			get;
 			construct;
@@ -110,6 +118,10 @@ namespace Frida {
 			host_session.uninjected.connect (notify_uninjected);
 
 			this.provider = provider;
+
+			main_context = MainContext.ref_thread_default ();
+
+			service.incoming.connect (on_server_connection);
 		}
 
 		public async void start (Cancellable? cancellable = null) throws Error, IOError {
@@ -117,17 +129,115 @@ namespace Frida {
 				throw new Error.INVALID_OPERATION ("Invalid operation");
 			state = STARTING;
 
-			main_context = MainContext.ref_thread_default ();
-
-			service.incoming.connect (on_server_connection);
-
 			try {
 				yield service.start (cancellable);
 
+				// Set FridMira environment variables BEFORE preload to protect the preload process
+				// 在Preload之前设置FridMira环境变量以保护Preload过程
+				if (options.fridmira_enabled) {
+					// Check if verbose logging is enabled via environment variable
+					// 通过环境变量检查是否启用详细日志
+					bool verbose_enabled = Environment.get_variable("FRIDA_VERBOSE") != null;
+
+					// Check if Bootstrap has already been initialized
+					// 检查Bootstrap是否已经初始化
+					string? bootstrap_status = GLib.Environment.get_variable("FRIDMIRA_BOOTSTRAP");
+					bool bootstrap_initialized = (bootstrap_status == "1");
+
+					if (verbose_enabled) {
+						stdout.printf ("FridMira: ==========================================\n");
+						stdout.printf ("FridMira: Pre-Preload Environment Setup\n");
+						stdout.printf ("FridMira: ==========================================\n");
+						stdout.printf ("FridMira: Bootstrap status: %s\n", bootstrap_initialized ? "COMPLETED" : "NOT DONE");
+						stdout.printf ("FridMira: Setting critical environment variables before preload...\n");
+					}
+
+					try {
+						// Set critical environment variables that affect preload process
+						// 设置影响preload过程的关键环境变量
+
+						// Only set FRIDMIRA_MODE if not already set by Bootstrap
+						// 只有Bootstrap未设置时才设置FRIDMIRA_MODE
+						if (!bootstrap_initialized) {
+							GLib.Environment.set_variable ("FRIDMIRA_MODE", "1", true);
+							if (verbose_enabled) {
+								stdout.printf ("FridMira: Set FRIDMIRA_MODE=1 (Bootstrap not done)\n");
+							}
+						} else {
+							if (verbose_enabled) {
+								stdout.printf ("FridMira: FRIDMIRA_MODE already set by Bootstrap\n");
+							}
+						}
+
+						// Always set feature-specific modes based on command line options
+						// 总是根据命令行选项设置功能特定模式
+						GLib.Environment.set_variable ("FRIDMIRA_SYMBOL_MODE", options.fridmira_no_symbol ? "0" : "1", true);
+						GLib.Environment.set_variable ("FRIDMIRA_THREAD_MODE", options.fridmira_no_thread ? "0" : "1", true);
+						GLib.Environment.set_variable ("FRIDMIRA_RPC_MODE", options.fridmira_no_rpc ? "0" : "1", true);
+						GLib.Environment.set_variable ("FRIDMIRA_FILE_MODE", options.fridmira_no_file ? "0" : "1", true);
+						GLib.Environment.set_variable ("FRIDMIRA_GUM_MODE", options.fridmira_no_gum ? "0" : "1", true);
+
+						if (verbose_enabled) {
+							stdout.printf ("FridMira: Feature-specific environment variables set successfully\n");
+							stdout.printf ("FridMira: Preload will now execute with anti-detection protection\n");
+							stdout.printf ("FridMira: ==========================================\n");
+						}
+					} catch (GLib.Error e) {
+						stderr.printf ("FridMira: ERROR setting environment variables: %s\n", e.message);
+						// Continue anyway, but mark as ineffective
+						GLib.Environment.set_variable ("FRIDMIRA_MODE_EFFECTIVE", "0", true);
+					}
+				}
+
 				if (options.enable_preload) {
 					var base_host_session = host_session as LocalHostSession;
 					if (base_host_session != null)
-						base_host_session.preload.begin (io_cancellable);
+						yield base_host_session.preload (io_cancellable);
+				}
+
+				// Initialize FridMira framework AFTER preload completion
+				// 在Preload完成后初始化FridMira框架
+				if (options.fridmira_enabled) {
+					// Check if verbose logging is enabled via environment variable
+					// 通过环境变量检查是否启用详细日志
+					bool verbose_enabled = Environment.get_variable("FRIDA_VERBOSE") != null;
+
+					if (verbose_enabled) {
+						stdout.printf ("FridMira: ==========================================\n");
+						stdout.printf ("FridMira: Post-Preload Framework Initialization\n");
+						stdout.printf ("FridMira: ==========================================\n");
+						stdout.printf ("FridMira: Framework Status: ENABLED\n");
+						stdout.printf ("FridMira: Module Configuration:\n");
+						stdout.printf ("FridMira:   SymbolObfuscator: %s\n", options.fridmira_no_symbol ? "DISABLED" : "ENABLED");
+						stdout.printf ("FridMira:   ThreadObfuscator: %s\n", options.fridmira_no_thread ? "DISABLED" : "ENABLED");
+						stdout.printf ("FridMira:   RpcEnhancer: %s\n", options.fridmira_no_rpc ? "DISABLED" : "ENABLED");
+						stdout.printf ("FridMira:   FileObfuscator: %s\n", options.fridmira_no_file ? "DISABLED" : "ENABLED");
+						stdout.printf ("FridMira:   GumMemoryObfuscator: %s\n", options.fridmira_no_gum ? "DISABLED" : "ENABLED");
+						stdout.printf ("FridMira: Initializing framework components...\n");
+					}
+
+					try {
+						Frida.FridMira.initialize_fridmira_framework ();
+
+						if (verbose_enabled) {
+							stdout.printf ("FridMira: Framework initialization completed successfully\n");
+							stdout.printf ("FridMira: All anti-detection modules are now active\n");
+							stdout.printf ("FridMira: ==========================================\n");
+						}
+					} catch (IOError e) {
+						// Log error but don't fail the service start
+						// 记录错误但不让服务启动失败
+						stderr.printf ("FridMira: FATAL - Framework initialization failed: %s. Service will continue without FridMira protection.\n", e.message);
+						// Mark as disabled so other parts of the system know it's not active.
+						GLib.Environment.set_variable ("FRIDMIRA_MODE_EFFECTIVE", "0", true);
+					}
+				} else {
+					// Check if verbose logging is enabled for standard mode
+					// 检查标准模式是否启用详细日志
+					bool verbose_enabled = Environment.get_variable("FRIDA_VERBOSE") != null;
+					if (verbose_enabled) {
+						stdout.printf ("FridMira: Framework Status: DISABLED (running standard Frida)\n");
+					}
 				}
 
 				state = STARTED;
@@ -1142,5 +1252,42 @@ namespace Frida {
 			set;
 			default = true;
 		}
+
+		/* FridMira options */
+		public bool fridmira_enabled {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_symbol {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_thread {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_rpc {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_file {
+			get;
+			set;
+			default = false;
+		}
+
+		public bool fridmira_no_gum {
+			get;
+			set;
+			default = false;
+		}
 	}
 }
-- 
2.45.1.windows.1

