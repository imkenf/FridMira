name: FridMira - Frida 16.7.19

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if release exists'
        required: false
        default: false
        type: boolean
  push:
    branches: ["main", "master"]
    paths:
      - ".github/workflows/build.yml"
      - "patches/**"

permissions:
  contents: write

env:
  FRIDA_VERSION: "16.7.19"
  FRIDMIRA_VERSION: "v1.10"

jobs:
  check_version:
    runs-on: ubuntu-22.04
    outputs:
      FRIDA_VERSION: ${{ env.FRIDA_VERSION }}
      FRIDMIRA_VERSION: ${{ env.FRIDMIRA_VERSION }}
      ALREADY_RELEASE: ${{ steps.checkReleaseVersion.outputs.ALREADY_RELEASE }}
    steps:
      - name: Check release version
        id: checkReleaseVersion
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            try {
              const releaseTag = '${{ env.FRIDA_VERSION }}-${{ env.FRIDMIRA_VERSION }}'
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: releaseTag
              });

              if ('${{ github.event.inputs.force_rebuild }}' === 'true' || '${{ github.event_name }}' === 'push') {
                console.log('Force rebuild requested, will recreate release');
                require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'ALREADY_RELEASE=2\n');
              } else {
                console.log('Release already exists, skipping build');
                require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'ALREADY_RELEASE=1\n');
              }
            } catch (e) {
              if(e.message.includes('Not Found')){
                console.log('Release does not exist, proceeding with build');
                require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'ALREADY_RELEASE=0\n');
              } else {
                core.setFailed(e.message);
              }
            }

      - name: Delete existing release
        if: ${{ steps.checkReleaseVersion.outputs.ALREADY_RELEASE == '2' }}
        uses: actions/github-script@v7
        with:
          script: |
            const releaseTag = '${{ env.FRIDA_VERSION }}-${{ env.FRIDMIRA_VERSION }}';
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: releaseTag
              });

              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id
              });

              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${releaseTag}`
              });

              console.log(`Deleted release and tag: ${releaseTag}`);
            } catch (error) {
              console.log(`Release ${releaseTag} not found or already deleted`);
            }

  create_release:
    needs: check_version
    runs-on: ubuntu-22.04
    if: needs.check_version.outputs.ALREADY_RELEASE != '1'
    outputs:
      release_id: ${{ steps.createRelease.outputs.id }}
    steps:
      - name: Create Release
        id: createRelease
        uses: softprops/action-gh-release@v2.1.0
        with:
          tag_name: "${{ needs.check_version.outputs.FRIDA_VERSION }}-${{ needs.check_version.outputs.FRIDMIRA_VERSION }}"
          name: "FridMira ${{ needs.check_version.outputs.FRIDA_VERSION }} - ${{ needs.check_version.outputs.FRIDMIRA_VERSION }}"
          body: |
            # ğŸš€ FridMira for Frida ${{ needs.check_version.outputs.FRIDA_VERSION }}

            ## âœ¨ å¢å¼ºç‰¹æ€§ / Enhanced Features
            - ç¬¦å·æ··æ·†ã€çº¿ç¨‹æ©ç›–ã€RPCå¢å¼º / Symbol obfuscation, thread masking, RPC enhancement
            - æ–‡ä»¶/socketåæ··æ·†ã€å†…ç½®åæ£€æµ‹ / File/socket name obfuscation, built-in anti-detection
            - GUMå†…å­˜æ··æ·†ã€å†…å­˜æ ‡è¯†ç¬¦éšè— / GUM memory obfuscation, memory identifier hiding
            - ç»†ç²’åº¦åŠŸèƒ½æ§åˆ¶ã€ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§ / Fine-grained control, environment variable priority

            ## ğŸ›ï¸ æ§åˆ¶æ–¹å¼ / Control Methods
            ```bash
            # å‘½ä»¤è¡Œæ§åˆ¶ / Command Line Control
            ./frida-server --fridmira                    # å¯ç”¨æ‰€æœ‰åŠŸèƒ½ / Enable all features
            ./frida-server --fridmira --fridmira-no-gum  # ç¦ç”¨GUMå†…å­˜æ··æ·† / Disable GUM memory obfuscation
            ./frida-server --fridmira --fridmira-no-symbol --fridmira-no-thread  # ç»„åˆæ§åˆ¶ / Combined control

            # ç¯å¢ƒå˜é‡æ§åˆ¶ / Environment Variable Control
            export FRIDMIRA_MODE=enabled          # å…¨å±€å¼€å…³ / Global switch
            export FRIDMIRA_GUM_MODE=disabled     # GUMç‰¹å®šæ§åˆ¶ / GUM-specific control
            export FRIDMIRA_VERBOSE=1             # è¯¦ç»†è¾“å‡º / Verbose output
            ```

            ## ğŸ“¦ ä½¿ç”¨æ–¹æ³• / Usage
            ```bash
            # ä¸‹è½½å¹¶ä½¿ç”¨ / Download and use
            wget https://github.com/${{ github.repository }}/releases/download/${{ needs.check_version.outputs.FRIDA_VERSION }}-${{ needs.check_version.outputs.FRIDMIRA_VERSION }}/fridmira-server-${{ needs.check_version.outputs.FRIDA_VERSION }}-android-arm64.gz
            gunzip fridmira-server-*.gz
            adb push fridmira-server-* /data/local/tmp/
            adb shell chmod 755 /data/local/tmp/fridmira-server-*
            adb shell /data/local/tmp/fridmira-server-* --fridmira &
            ```

            ## ğŸ›¡ï¸ åæ£€æµ‹èƒ½åŠ› / Anti-Detection Capabilities
            - âœ… ç¬¦å·æ··æ·† / Symbol obfuscation
            - âœ… çº¿ç¨‹æ©ç›– / Thread masking
            - âœ… å†…å­˜æ··æ·† / Memory obfuscation
            - âœ… RPCå¢å¼º / RPC enhancement
            - âœ… æ–‡ä»¶æ··æ·† / File obfuscation
            - âœ… å†…ç½®åæ£€æµ‹ / Built-in anti-detection

          prerelease: false
          draft: false

  android_build:
    runs-on: ubuntu-22.04
    needs: [check_version, create_release]
    if: needs.check_version.outputs.ALREADY_RELEASE != '1'
    strategy:
      matrix:
        arch: [android-arm, android-arm64, android-x86, android-x86_64]
      fail-fast: false
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: "temurin"
        java-version: "17"

    - name: Setup Android NDK
      id: setup-ndk
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        local-cache: false
        link-to-sdk: true

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: 3.11

    - name: Install dependencies
      run: |
        sudo apt-get update && DEBIAN_FRONTEND=noninteractive sudo apt-get install \
          build-essential ninja-build gcc-multilib g++-multilib lib32stdc++-9-dev \
          flex bison ruby ruby-dev python3-requests python3-setuptools python3-dev \
          python3-pip libc6-dev libc6-dev-i386 git -y
        sudo gem install fpm -v 1.11.0 --no-document

    - name: Build FridMira for ${{ matrix.arch }}
      shell: bash
      env:
        ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
      run: |
        set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

        # é…ç½®git
        git config --global user.name "FridMira Bot"
        git config --global user.email "fridmira@github.actions"

        echo "ğŸš€ Building FridMira Frida ${{ env.FRIDA_VERSION }} for ${{ matrix.arch }}"

        # å…‹éš†å¹¶åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬
        git clone --recursive https://github.com/frida/frida.git
        cd frida
        git checkout ${{ env.FRIDA_VERSION }}
        git submodule update --init --recursive
        echo "âœ… Frida ${{ env.FRIDA_VERSION }} ready ($(git describe --tags))"

        # éªŒè¯patchesç›®å½•
        if [[ ! -d "../patches" ]]; then
          echo "âŒ Patches directory not found!"
          exit 1
        fi

        # åº”ç”¨frida-gum patches
        echo "ğŸ“¦ Applying frida-gum patches..."
        for patch in $(find ../patches/frida-gum -name "*.patch" | sort); do
          patch_name=$(basename "$patch")
          echo "ğŸ”„ Applying: $patch_name"
          if ! (cd subprojects/frida-gum && git apply -v --reject -p1 < "../../../patches/frida-gum/$patch_name"); then
            echo "âŒ Failed to apply patch: $patch_name"
            echo "ğŸ” Patch content:"
            head -20 "$patch"
            exit 1
          fi
          echo "âœ… Applied: $patch_name"
        done

        # åº”ç”¨frida-core patches
        echo "ğŸ“¦ Applying frida-core patches..."
        for patch in $(find ../patches/frida-core -name "*.patch" | sort); do
          patch_name=$(basename "$patch")
          echo "ğŸ”„ Applying: $patch_name"
          if ! (cd subprojects/frida-core && git apply -v --reject -p1 < "../../../patches/frida-core/$patch_name"); then
            echo "âŒ Failed to apply patch: $patch_name"
            echo "ğŸ” Patch content:"
            head -20 "$patch"
            echo "ğŸ” Git status:"
            (cd subprojects/frida-core && git status)
            exit 1
          fi
          echo "âœ… Applied: $patch_name"
        done

        # éªŒè¯fridmira.valaå·²æ­£ç¡®æ·»åŠ åˆ°æ„å»ºç³»ç»Ÿ
        if [[ -f "subprojects/frida-core/lib/base/fridmira.vala" ]]; then
          if grep -q "fridmira.vala" subprojects/frida-core/lib/base/meson.build; then
            echo "âœ… fridmira.vala is correctly added to build system"
          else
            echo "âŒ fridmira.vala not found in meson.build - patch may have failed"
            exit 1
          fi
        fi

        echo "âœ… All FridMira patches applied successfully"

        # æ„å»º
        echo "ğŸ”¨ Building for ${{ matrix.arch }}..."
        cd ..
        mkdir -p build-${{ matrix.arch }}
        cd build-${{ matrix.arch }}

        # é…ç½®æ„å»º
        if ! ../frida/configure --host=${{ matrix.arch }}; then
          echo "âŒ Configure failed for ${{ matrix.arch }}"
          if [[ -f "../frida/releng/setup-env.sh" ]]; then
            echo "ğŸ”„ Trying releng setup..."
            source ../frida/releng/setup-env.sh
            ../frida/configure --host=${{ matrix.arch }}
          else
            exit 1
          fi
        fi

        # ç¼–è¯‘
        echo "ğŸ”¨ Compiling..."
        if ! make -j$(nproc); then
          echo "âŒ Build failed, trying single-threaded..."
          make -j1
        fi

        # è°ƒè¯•ï¼šæ˜¾ç¤ºæ„å»ºäº§ç‰©ç›®å½•ç»“æ„
        echo "ğŸ” Build output structure:"
        find . -name "frida-server" -o -name "frida-inject" -o -name "frida-gadget.so" -o -name "libfrida-gumjs-1.0.a" | head -20

        # éªŒè¯æ„å»ºäº§ç‰©
        required_files=(
          "./subprojects/frida-core/server/frida-server"
          "./subprojects/frida-core/inject/frida-inject"
          "./subprojects/frida-core/lib/gadget/frida-gadget.so"
          "./subprojects/frida-gum/bindings/gumjs/libfrida-gumjs-1.0.a"
        )

        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "âŒ Missing required file: $file"
            exit 1
          fi
        done

        echo "âœ… FridMira build completed successfully for ${{ matrix.arch }}"

    - name: Package build results
      shell: bash
      run: |
        mkdir -p dist

        # æ‰“åŒ…æ‰€æœ‰ç»„ä»¶
        cp ./build-${{ matrix.arch }}/subprojects/frida-core/server/frida-server ./dist/fridmira-server-${{ env.FRIDA_VERSION }}-${{ matrix.arch }}
        cp ./build-${{ matrix.arch }}/subprojects/frida-core/inject/frida-inject ./dist/fridmira-inject-${{ env.FRIDA_VERSION }}-${{ matrix.arch }}
        cp ./build-${{ matrix.arch }}/subprojects/frida-core/lib/gadget/frida-gadget.so ./dist/fridmira-gadget-${{ env.FRIDA_VERSION }}-${{ matrix.arch }}.so
        cp ./build-${{ matrix.arch }}/subprojects/frida-gum/bindings/gumjs/libfrida-gumjs-1.0.a ./dist/fridmira-gumjs-${{ env.FRIDA_VERSION }}-${{ matrix.arch }}.a

        # å‹ç¼©
        gzip -9 ./dist/*

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fridmira-${{ matrix.arch }}
        path: ./dist/
        retention-days: 1

  upload_to_release:
    needs: [check_version, create_release, android_build]
    runs-on: ubuntu-22.04
    if: needs.check_version.outputs.ALREADY_RELEASE != '1'
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Upload All Files to Release
      uses: softprops/action-gh-release@v2.1.0
      with:
        tag_name: "${{ needs.check_version.outputs.FRIDA_VERSION }}-${{ needs.check_version.outputs.FRIDMIRA_VERSION }}"
        files: |
          ./artifacts/fridmira-android-arm/*.gz
          ./artifacts/fridmira-android-arm64/*.gz
          ./artifacts/fridmira-android-x86/*.gz
          ./artifacts/fridmira-android-x86_64/*.gz

  build_summary:
    needs: [check_version, create_release, android_build, upload_to_release]
    runs-on: ubuntu-22.04
    if: always()
    steps:
    - name: Build Summary
      run: |
        echo "ğŸ‰ FridMira Build Summary"
        echo "========================="
        echo "Frida Version: ${{ needs.check_version.outputs.FRIDA_VERSION }}"
        echo "FridMira Version: ${{ needs.check_version.outputs.FRIDMIRA_VERSION }}"
        echo "Build Status: ${{ needs.android_build.result }}"

        if [[ "${{ needs.android_build.result }}" == "success" ]]; then
          echo "âœ… All architectures built successfully!"
          echo "ğŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.check_version.outputs.FRIDA_VERSION }}-${{ needs.check_version.outputs.FRIDMIRA_VERSION }}"
          echo ""
          echo "ğŸ¯ Available components:"
          echo "  - fridmira-server-16.7.19-{arch}.gz"
          echo "  - fridmira-inject-16.7.19-{arch}.gz"
          echo "  - fridmira-gadget-16.7.19-{arch}.so.gz"
          echo "  - fridmira-gumjs-16.7.19-{arch}.a.gz"
          echo ""
          echo "ğŸš€ Quick start:"
          echo "  ./fridmira-server --fridmira"
          echo "  ./fridmira-server --fridmira --fridmira-no-gum"
        else
          echo "âŒ Build failed. Check logs for details."
          exit 1
        fi
